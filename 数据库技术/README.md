# 图书管理系统 · 数据库技术课程项目

**数据库技术 · 课程大作业** | 2022 年秋 · **主修**项目 · **课程总成绩 99 分**

基于 **Microsoft SQL Server** 与 **Python** 的完整图书借阅管理系统，提供**命令行**端使用，涵盖建库、约束、触发器、存储过程、视图、索引及备份恢复等数据库技术实践。

## 项目概述

本系统实现图书馆场景下的图书分类、馆藏管理、读者管理、借还书、逾期扣款、充值扣款及管理员操作审计等功能。数据库设计强调**完整性约束**、**业务规则自动化**（触发器）与**可追溯性**（操作记录不可篡改）。

| 项目属性   | 说明                         |
| ---------- | ---------------------------- |
| 课程       | 数据库技术                   |
| 学期与性质 | 2022 年秋 · 主修项目         |
| 课程总成绩 | 99 分                        |
| 数据库     | Microsoft SQL Server         |
| 应用层     | Python（命令行）             |

## 技术栈

| 层次       | 技术                                                                 |
| ---------- | -------------------------------------------------------------------- |
| 数据库     | Microsoft SQL Server（T-SQL）                                        |
| 命令行端   | Python 3.8+、pymssql、pandas；keyboard 仅非 macOS 用于分页（macOS 用回车/n/q） |
| 驱动       | pymssql                                                              |

## 系统功能

### 角色与入口

- **管理员**：登录后进入管理端（图书 / 读者 / 借阅 / 管理员管理、备份与恢复、重要操作记录）。
- **读者**：读者编号 + 密码登录，可检索图书、查看当前/历史借阅、充值记录、修改密码。

（本版本仅提供管理员与读者两种登录身份，无访客入口。）

### 核心业务

- **图书管理**：按分类维护馆藏，支持按 ISBN/书名/作者等检索；图书状态：在馆 / 借出 / 丢失 / 损坏。
- **读者管理**：读者类型（教师 / 研究生 / 本科生 / 其他）与编号长度、借阅数目/天数限制一致；支持增删改查与密码重置。
- **借阅与归还**：借书时校验在借数量上限与应还日期；还书时写入历史借阅，逾期自动扣款（触发器）。
- **充值扣款**：读者余额变动记录在「充值扣款记录」；逾期罚款由触发器写入并扣款，记录不可修改。
- **管理员审计**：重要操作（如删除读者、重置密码、余额变动）写入「管理员重要操作记录」，表禁止更新与删除（触发器保护）。
- **备份与恢复**：支持数据库备份与从备份文件恢复。备份/恢复路径在 `main.py` 中 `Backup()` / `Restore()` 内配置（默认为本机路径，其他环境需修改后使用）。

### 运行方式

- **命令行端**（`main.py`）：控制台菜单式操作，分页展示查询结果（pandas DataFrame）；Windows 下用 keyboard 翻页（=/-），macOS 下用回车/n/q 翻页（避免 CFData 断言崩溃）。适合本地/机房环境直接操作数据库。

## 数据库设计要点

> **说明**：原作业要求包含 **E-R 图**，但该文件已丢失，此处仅保留基于 E-R 设计实现的表结构、约束与业务逻辑描述。

### 表结构（部分）

| 表名 | 说明 |
|------|------|
| 图书分类 | 分类编码（主键）、分类名称 |
| 图书信息 | 图书编号、分类编码、ISBN、书名、作者、出版社、出版日期、单价、简介、状态（在馆/借出/丢失/损坏） |
| 读者信息 | 读者编号、姓名、性别、类型、数目限制、时间限制、联系方式、余额、密码 |
| 借阅信息 | 借阅编号、图书编号、ISBN、读者编号、借阅日期、应还日期 |
| 历史借阅信息 | 历史借阅编号、图书/读者/借阅日期/应还/实还日期 |
| 管理员信息 | 管理员编号、是否为主管理员、账号、密码（主管理员可添加/删除其他管理员） |
| 充值扣款记录 | 记录编号、读者编号、变动金额、变动日期、管理员账号、变动原因 |
| 管理员重要操作记录 | 记录编号、管理员账号、受影响读者/管理员、操作时间、操作内容、操作原因 |
| 备份恢复记录 | 备份编号、备份/恢复时间与路径 |

### 约束与业务规则

- **主键、外键**：保证引用完整；部分表使用 `ON DELETE CASCADE`（如读者删除时级联删除其充值扣款、历史借阅等）。
- **CHECK 约束**：如 ISBN 长度 10/13、读者编号长度与类型对应（教师/研究生 6 位，本科生/其他 10 位）、性别、余额 ≥ 0、状态枚举、密码长度等。
- **唯一约束**：如管理员账号唯一。

### 触发器（部分）

| 触发器 | 表 | 作用 |
|--------|-----|------|
| 借阅权限生成触发器 | 读者信息 | INSERT/UPDATE 时按类型自动设置数目限制、时间限制（教师 15 本/180 天，研究生 10/180，本科生 5/60，其他 5/30） |
| 数目超限警告触发器 | 借阅信息 | INSERT 时检查在借数量是否超过该读者数目限制，超限则 RAISERROR + ROLLBACK |
| 应还日期填充触发器 | 借阅信息 | INSERT/UPDATE 时按读者时间限制自动计算并填充应还日期 |
| 逾期扣款触发器 | 历史借阅信息 | INSERT 时若实还日期 > 应还日期，按天数计算罚款、扣减余额并写入充值扣款记录（事务内完成） |
| 禁止修改历史借阅信息触发器 | 历史借阅信息 | INSTEAD OF UPDATE，禁止修改历史记录 |
| 禁止更新删除管理员重要操作记录触发器 | 管理员重要操作记录 | INSTEAD OF UPDATE/DELETE，保证审计记录不可篡改 |
| 禁止更新充值扣款记录触发器 | 充值扣款记录 | INSTEAD OF UPDATE，保证流水不可改 |

### 视图与存储过程

- **视图**：如「所有读者当前借阅图书数量视图」、「总借阅量TOP10视图」等，用于统计与报表。
- **存储过程**：覆盖图书上架/下架、借阅/归还、读者与管理员增删改查、密码重置、充值、备份/恢复、读者/管理员自助查询等 20+ 个业务操作，命令行端通过调用存储过程或等效 SQL 完成业务。

### 索引

- 对 `图书信息(ISBN)`、`借阅信息(读者编号, 图书编号, ISBN)`、`历史借阅信息(读者编号, 图书编号, ISBN)`、`充值扣款记录(读者编号)` 建立非聚集索引，用于加速查询与统计。

## 项目结构

```
数据库技术/
├── README.md                 # 本文件
├── pyproject.toml            # 项目与依赖（推荐 uv sync；另有 requirements.txt 可由 uv export 生成供 pip）
├── docker.sh                 # 可选：启动 Azure SQL Edge 容器（卷 sqledge-data，详见脚本内 Mac 优势说明）
├── main.py                   # 命令行端（pymssql + pandas，菜单式操作；跨平台 pause/清屏）
├── init.py                   # 数据库初始化脚本（建库、建表、触发器、视图、存储过程、测试数据，可由 Python 执行）
└── schema.sql                # 完整 T-SQL 脚本（与 init.py 结构一致：建库、表、约束、索引、触发器、视图、存储过程、示例数据）
```

## 环境与运行

### 环境要求

- **数据库**：Microsoft SQL Server（建议 2016 及以上），或使用本目录 `docker.sh` 启动 Azure SQL Edge 容器。
- **Python**：3.8+。推荐使用 **uv** 管理依赖（与 `pyproject.toml` 一致），也可使用 pip。

### 依赖安装（命令行端）

推荐使用 uv：

```bash
cd 数据库技术
uv sync
```

或使用 pip：`pip install pymssql pandas keyboard`（keyboard 仅非 macOS 用于分页；macOS 下用回车/n/q 翻页）。

### 运行步骤（推荐顺序）

1. **配置数据库** — 执行 `docker.sh` 启动 Azure SQL Edge 容器（镜像见脚本内说明，Mac 下支持原生 ARM64）。容器名 **sqledge**，端口 1433，就绪约 20～40 秒。
2. **初始化库表** — 执行 `uv run python init.py`（或 `python init.py`），按提示输入主机（如 localhost）、账号 **sa**、密码（与 `docker.sh` 中 `SA_PASSWORD` 一致）。init.py 会建库、建表、触发器、视图、存储过程及示例数据，并包含**部分测试**。
3. **运行命令行界面** — 执行 `uv run python main.py`（或 `python main.py`），按提示连接数据库并选择 **BOOKS** 库，随后以管理员或读者身份登录。初始化后默认管理员 **admin / admin**。

若不用 Docker，可自行安装 SQL Server 后，用 **schema.sql**（在 SSMS 中执行）替代步骤 2，再执行步骤 3。

### 默认连接与密码（示例）

| 场景 | 说明 |
|------|------|
| **init.py 交互默认** | 主机为空回车为 `.`；账号 **sa**；密码默认 `Lxy@2026sql`（与 Docker 一致时可回车）。 |
| **Docker（docker.sh）** | 容器 **sqledge**，主机 **localhost**，端口 **1433**，账号 **sa**，密码见脚本内 `SA_PASSWORD`。 |

### 其他说明

- **备份/恢复**：管理员菜单中备份与恢复需在 `main.py` 的 `Backup()`、`Restore()` 内配置本机可用路径（默认示例见代码）。
- **中文显示**：建库使用 `COLLATE Chinese_PRC_CI_AS`，应用层 UTF-8；终端为 UTF-8 时中文正常显示。
- **schema.sql 与 init.py**：结构一致，可二选一建库；init.py 重复执行会先 DROP 再 CREATE，便于反复初始化。

## 个人与课程说明

本项目为**数据库技术**课程大作业（**课程总成绩 99 分**），重点体现：

- **数据库建模**：多表设计、主外键、CHECK 与唯一约束。（原作业要求含 E-R 图，该文件已丢失。）
- **T-SQL 编程**：触发器实现业务规则（借阅权限、应还日期、超限校验、逾期扣款、记录保护）。
- **视图与存储过程**：统计视图与完整业务封装。
- **索引**：针对常用查询与关联的非聚集索引。
- **备份与恢复**：在应用层调用 T-SQL 备份/恢复。
- **应用层对接**：命令行端（pymssql）访问数据库完成业务操作。

README 仅作项目说明与简历/作品集展示之用。

## 许可证

本项目为课程作业，仅供学习与展示。
